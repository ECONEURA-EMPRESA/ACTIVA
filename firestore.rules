rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- RULES ---

    // 1. USERS
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      
      // Subcollection: Group Sessions (Titanium Fix)
      match /group_sessions/{sessionId} {
        allow read, write: if isOwner(userId);
      }
    }

    // 2. SETTINGS
    // New path: settings/{userId}
    match /settings/{userId} {
      allow read, write: if isOwner(userId);
    }

    // 3. PATIENTS & SESSIONS (Subcollection)
    match /patients/{patientId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid);
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isOwner(resource.data.userId);

      // Subcollection: Sessions
      match /sessions/{sessionId} {
        allow read, write: if isOwner(get(/databases/$(database)/documents/patients/$(patientId)).data.userId);
      }
    }

    // 4. SESSIONS (Collection Group Query)
    match /{path=**}/sessions/{sessionId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid);
    }

    // 5. ACTIVITY LOGS (Immutable Audit Trail)
    // Only allows CREATE. Delete/Update is FORBIDDEN.
    match /activity_logs/{logId} {
       allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
       allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
       allow update, delete: if false; // IMMUTABLE
    }


    // 6. DAILY NOTES (Added for Dashboard)
    match /daily_notes/{noteId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // 7. INVOICES (Titanium Billing)
    match /invoices/{invoiceId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Default Deny
    match /{document=**} {
      allow read, write: if false; 
    }
  }
}
